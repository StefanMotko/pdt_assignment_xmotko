# Overview

The application gives the user some general utility functions for car traveling:
- the user can mark their location and be shown a nearby fuel station
- the user canmark their starting and ending location of a trip and be shown fuel station coverage in the general trip area
- the user can input a series of locations to stop at and the app will calculate the distance to travel between them

The application has 2 separate parts, the client which is a [frontend web application](#frontend) using Mapbox API and Leaflet.js and the [backend application](#backend) written in [ExpressJS](https://expressjs.com/), backed by PostGIS. The frontend application communicates with backend using a JSON-based API.

# Frontend

The frontend application is a static HTML page template in EJS format (`index.ejs`), which shows Leaflet.js widget. It defaults to the standard style, since it does a very good job of capturing roads.

All relevant frontend code is in `view_index.js` which is referenced from `index.ejs`. The frontend code is very simple, its only responsibilities are:
- translating user input into web service invocations
- show results of user actions back to the user

# Backend

The backend application is written in ExpressJS and is responsible for querying geo data and formatting the geojson.

## Data

Road and fuel station data is coming directly from Open Street Maps. I downloaded an extent covering whole Slovakia from the geofabrik Open Street Maps mirror(`http://download.geofabrik.de/`) in pbf binary format and imported it using the `osm2pgsql` tool into the standard OSM schema in SRID 3857. To speedup the queries I created a lookup table fuel_roads consisting of records from the Open Street Maps roads relation matched with fuel station IDs. The application dynamically serves all exported members of `query/query.js` as POST-basd web services. GeoJSON is generated by using a standard `st_asgeojson` function, however some postprocessing is necessary (in `query/query.js`) in order to merge all roads and other data into a single geojson.

## Api

Described at

`GET /api`.
All services return some form of JSON, some of which are valid geoJSON, and some where geoJSON would be pointless.

## Running it

0. Have Node.js and PostgreSQL installed
1. Setup postgresql, postgis, osm data.
2. Setup fuel_roads table:

DROP TABLE fuel_roads;
WITH fuelroads AS 
(SELECT p.osm_id, p.way, (SELECT r.osm_id FROM planet_osm_roads r ORDER BY ST_Distance(ST_Transform(p.way, 4326), ST_Transform(r.way, 4326)) ASC LIMIT 1) as road_id FROM planet_osm_point p 
WHERE amenity LIKE 'fuel')
SELECT * INTO fuel_roads FROM fuelroads

3. $ npm install
4. $ npm run start
